(window.webpackJsonp=window.webpackJsonp||[]).push([[65],{468:function(t,s,a){"use strict";a.r(s);var n=a(34),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"嵌入语言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#嵌入语言"}},[t._v("#")]),t._v(" 嵌入语言")]),t._v(" "),a("hr"),t._v(" "),a("p",[t._v("VS Code 为编程语言提供了丰富的功能。就如你在 "),a("a",{attrs:{href:"/language-extensions/language-server-extension-guide"}},[t._v("语言服务器")]),t._v(" 中看到的那样，语言服务器可以支持任何编程语言。但要支持嵌入的语言，我们还要做更多工作。")]),t._v(" "),a("p",[t._v("时至今日，嵌入语言日与俱增，比如：")]),t._v(" "),a("ul",[a("li",[t._v("HTML 中的 JavaScript 和 CSS")]),t._v(" "),a("li",[t._v("JavaScript 中的 JSX")]),t._v(" "),a("li",[t._v("模板语法，比如 Vue，Handlebars 和 Razor")]),t._v(" "),a("li",[t._v("PHP 中的 HTML")])]),t._v(" "),a("p",[t._v("本篇指南着重于实现嵌入语言的各种语言功能。如果你只是对嵌入语言的语法高亮感兴趣，请参考"),a("a",{attrs:{href:"/language-extensions/syntax-highlight-guide"}},[t._v("语法高亮指南")]),t._v("。")]),t._v(" "),a("p",[t._v("本指南包含两个示例，它们介绍了 2 种构建嵌入语言服务器的方法——"),a("strong",[t._v("语言服务")]),t._v("和"),a("strong",[t._v("请求转发")]),t._v("。我们将学习这两个示例，并了解它们各自的优点和缺点。")]),t._v(" "),a("p",[t._v("示例代码见下：")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/microsoft/vscode-extension-samples/tree/master/lsp-embedded-language-service",target:"_blank",rel:"noopener noreferrer"}},[t._v("嵌入语言服务器（语言服务实现）"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/microsoft/vscode-extension-samples/tree/master/lsp-embedded-request-forwarding",target:"_blank",rel:"noopener noreferrer"}},[t._v("嵌入语言服务器（请求转发实现）"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("我们先看看我们要构建的嵌入语言服务器实现的效果：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://code.visualstudio.com/assets/api/language-extensions/embedded-languages/embedded-lsp-sample.gif",alt:"embedded languages"}})]),t._v(" "),a("p",[t._v("两个示例都分别配置了一个新的语言——"),a("code",[t._v("html1")]),t._v("。你可以创建一个"),a("code",[t._v(".html1")]),t._v("文件，然后测试下列功能：")]),t._v(" "),a("ul",[a("li",[t._v("HTML 标签的自动填充")]),t._v(" "),a("li",[a("code",[t._v("<style>")]),t._v("标签中 CSS 的自动填充功能")]),t._v(" "),a("li",[t._v("CSS 语法诊断（仅在"),a("strong",[t._v("语言服务")]),t._v("实现中可用）")])]),t._v(" "),a("h2",{attrs:{id:"语言服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#语言服务"}},[t._v("#")]),t._v(" 语言服务")]),t._v(" "),a("hr"),t._v(" "),a("p",[a("strong",[t._v("语言服务")]),t._v("是实现了"),a("a",{attrs:{href:"https://code.visualstudio.com/api/language-extensions/programmatic-language-features",target:"_blank",rel:"noopener noreferrer"}},[t._v("程序性语言功能"),a("OutboundLink")],1),t._v("的库。"),a("strong",[t._v("语言服务器")]),t._v("可嵌入到语言服务中，解决嵌入语言的各类问题。")]),t._v(" "),a("p",[t._v("下面是 VS Code 为 HTML 提供的功能大纲：")]),t._v(" "),a("ul",[a("li",[t._v("内建的 "),a("a",{attrs:{href:"https://github.com/microsoft/vscode/tree/master/extensions/html",target:"_blank",rel:"noopener noreferrer"}},[t._v("html 插件"),a("OutboundLink")],1),t._v(" 只提供了语法高亮和 HTML 的语言配置能力")]),t._v(" "),a("li",[t._v("内建的 "),a("a",{attrs:{href:"https://github.com/microsoft/vscode/tree/master/extensions/html-language-features",target:"_blank",rel:"noopener noreferrer"}},[t._v("html 语言功能插件"),a("OutboundLink")],1),t._v("包含 HTML 语言服务器，为 HTML 提供程序性语言特性")]),t._v(" "),a("li",[t._v("HTML 语言服务器使用 "),a("a",{attrs:{href:"https://github.com/microsoft/vscode-html-languageservice",target:"_blank",rel:"noopener noreferrer"}},[t._v("vscode-html-languageservice"),a("OutboundLink")],1),t._v(" 支持 HTML")]),t._v(" "),a("li",[t._v("CSS 语言服务器使用 "),a("a",{attrs:{href:"https://github.com/microsoft/vscode-css-languageservice",target:"_blank",rel:"noopener noreferrer"}},[t._v("vscode-css-languageservice"),a("OutboundLink")],1),t._v(" 支持 HTML 中的 CSS")])]),t._v(" "),a("p",[t._v("HTML 语言服务器分析 HTML 文档，将其分解为"),a("strong",[t._v("语言域")]),t._v("，然后使用对应的"),a("strong",[t._v("语言服务")]),t._v("处理语言服务器的请求。")]),t._v(" "),a("p",[t._v("比如：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("<|")]),t._v(" 的自动补全请求，HTML 语言服务器使用 HTML 语言服务提供 HTML 的自动补全。")]),t._v(" "),a("li",[a("code",[t._v("<style>.foo { | }</style>")]),t._v(" 的自动补全请求，HTML 语言服务器则使用 CSS 语言服务器提供 CSS 补全功能。")])]),t._v(" "),a("p",[t._v("现在让我们在 "),a("a",{attrs:{href:"https://github.com/microsoft/vscode-extension-samples/tree/master/lsp-embedded-language-service",target:"_blank",rel:"noopener noreferrer"}},[t._v("lsp-embedded-language-service"),a("OutboundLink")],1),t._v(" 示例中检验一下。")]),t._v(" "),a("h3",{attrs:{id:"语言服务示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#语言服务示例"}},[t._v("#")]),t._v(" 语言服务示例")]),t._v(" "),a("p",[t._v("!> 注意: 本示例假设你已经掌握了 "),a("a",{attrs:{href:"https://code.visualstudio.com/api/language-extensions/programmatic-language-features",target:"_blank",rel:"noopener noreferrer"}},[t._v("程序性语言特性"),a("OutboundLink")],1),t._v(" 和 "),a("a",{attrs:{href:"/language-extensions/language-server-extension-guide"}},[t._v("语言服务器")]),t._v(" 这2章内容。本示例构建于 "),a("a",{attrs:{href:"https://github.com/microsoft/vscode-extension-samples/tree/master/lsp-sample",target:"_blank",rel:"noopener noreferrer"}},[t._v("lsp-sample"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("与 "),a("a",{attrs:{href:"https://github.com/microsoft/vscode-extension-samples/tree/master/lsp-sample",target:"_blank",rel:"noopener noreferrer"}},[t._v("lsp-sample"),a("OutboundLink")],1),t._v(" 相同的是，本示例的客户端代码都是一样的。")]),t._v(" "),a("p",[t._v("我们刚刚在上面提到了，服务器会将文档切分为不同的"),a("strong",[t._v("语言域")]),t._v("，然后分别处理对应的嵌入内容。")]),t._v(" "),a("p",[t._v("我看个简单示例")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("style")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token style"}},[a("span",{pre:!0,attrs:{class:"token language-css"}},[a("span",{pre:!0,attrs:{class:"token selector"}},[t._v(".foo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("style")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("这个例子里，服务器检测到"),a("code",[t._v("<style>")]),t._v("标签，然后将 "),a("code",[t._v(".foo{ }")]),t._v(" 标记为 "),a("strong",[t._v("CSS 域")]),t._v("。")]),t._v(" "),a("p",[t._v("特定位置产生的自动补全请求，服务器会遵循下列逻辑返回响应对象：")]),t._v(" "),a("ul",[a("li",[t._v("如果当前位置属于**“域”**\n"),a("ul",[a("li",[t._v("为域中的语言生成一份虚拟文档，其他域则使用空白符填充")])])]),t._v(" "),a("li",[t._v("如果当前位置不属于任何**“域”**\n"),a("ul",[a("li",[t._v("使用 HTML 虚拟文档处理，所有域都视为空白符")])])])]),t._v(" "),a("p",[t._v("比如，当我在下列光标位置使用自动补全")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("style")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token style"}},[a("span",{pre:!0,attrs:{class:"token language-css"}},[a("span",{pre:!0,attrs:{class:"token selector"}},[t._v(".foo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" | "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("style")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("服务器会现当前位置在**“域”**中，然后生成一个虚拟 CSS 文档，该文档包含下面的内容（█ 表示空白符）")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[t._v("███████████\n███████.foo { | }████████\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("服务器随后使用 "),a("code",[t._v("vscode-css-languageservice")]),t._v(" 分析该文档，然后计算出一个自动补全项的列表。因为现在内容不包含 HTML 了，所以 CSS 语言服务器就可以轻松地处理了。通过将非CSS 内容替换为空白符，我们就不用手动处理语言事件发生的具体位置和偏移位置了。")]),t._v(" "),a("p",[t._v("处理补全请求的服务端代码：")]),t._v(" "),a("div",{staticClass:"language-typescript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-typescript"}},[a("code",[t._v("connection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onCompletion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("textDocumentPosition"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" document "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" documents"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("textDocumentPosition"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("textDocument"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("uri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" mode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" languageModes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getModeAtPosition")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" textDocumentPosition"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("position"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("mode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("mode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("doComplete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" CompletionList"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" doComplete "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("doComplete"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("doComplete")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" textDocumentPosition"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("position"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])]),a("p",[t._v("CSS 模型则负责处理落入 CSS 域的所有语言服务器请求")]),t._v(" "),a("div",{staticClass:"language-typescript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-typescript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCSSMode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  cssLanguageService"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" CSSLanguageService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  documentRegions"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" LanguageModelCache"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("HTMLDocumentRegions"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" LanguageMode "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'css'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("doComplete")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("document"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" TextDocument"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" position"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Position"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Get virtual CSS document, with all non-CSS code replaced with whitespace")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" embedded "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" documentRegions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getEmbeddedDocument")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'css'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Compute a response with vscode-css-languageservice")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" stylesheet "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" cssLanguageService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("parseStylesheet")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("embedded"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" cssLanguageService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("doComplete")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("embedded"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" position"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" stylesheet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br")])]),a("p",[t._v("这是个处理嵌入语言非常简单有效的办法。但是这个方法也有很多问题：")]),t._v(" "),a("ul",[a("li",[t._v("你需要持续更新维护"),a("strong",[t._v("语言服务器")]),t._v("依赖的"),a("strong",[t._v("语言服务")])]),t._v(" "),a("li",[t._v("你的"),a("strong",[t._v("语言服务器")]),t._v("很难引入一个非同语言实现的"),a("strong",[t._v("语言服务")]),t._v("。比如用 PHP 实现的 PHP 语言服务器很难接入 TypeScript实现的 "),a("code",[t._v("vscode-css-languageservice")]),t._v("。")])]),t._v(" "),a("p",[t._v("别急，我们马上来实现 "),a("code",[t._v("请求转发")]),t._v(" 解决上面的问题。")]),t._v(" "),a("h2",{attrs:{id:"请求转发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#请求转发"}},[t._v("#")]),t._v(" 请求转发")]),t._v(" "),a("hr"),t._v(" "),a("p",[t._v("简单来说，请求转发和语言服务的工作机制是类似的。请求转发方法，也接收语言服务器的请求，计算虚拟文档，然后返回结果。")]),t._v(" "),a("p",[t._v("主要的不同点在于：")]),t._v(" "),a("ul",[a("li",[t._v("语言服务使用"),a("strong",[t._v("库")]),t._v("去响应语言语言服务器，而请求转发则把请求发送回 VS Code 查询所有的语言服务器，然后转发它们的处理结果。")]),t._v(" "),a("li",[t._v("分发工作由语言客户端处理，而不是语言服务器")])]),t._v(" "),a("p",[t._v("我们再来看下这个例子：")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("style")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token style"}},[a("span",{pre:!0,attrs:{class:"token language-css"}},[a("span",{pre:!0,attrs:{class:"token selector"}},[t._v(".foo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" | "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("style")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("补全工作的流程像这样：")]),t._v(" "),a("ul",[a("li",[t._v("语言客户端为"),a("code",[t._v("embedded-content")]),t._v(" 注册一个虚拟文本文档供应器函数（"),a("code",[t._v("workspace.registerTextDocumentContentProvider")]),t._v("）")]),t._v(" "),a("li",[t._v("语言服务器劫取"),a("code",[t._v("<FILE_URI>")]),t._v("的补全请求")]),t._v(" "),a("li",[t._v("语言服务器确定请求位置落入 "),a("strong",[t._v("CSS 域")])]),t._v(" "),a("li",[t._v("语言服务器构建一个新的 URI，比如 "),a("code",[t._v("embedded-content://css/<FILE_URI>.css")])]),t._v(" "),a("li",[t._v("然后服务器调用 "),a("code",[t._v("commands.executeCommand('vscode.executeCompletionItemProvider', ...)")]),t._v(" "),a("ul",[a("li",[t._v("VS Code 的 CSS 语言服务器响应该请求")]),t._v(" "),a("li",[t._v("虚拟文本文档供应器函数，给 CSS 语言服务器提供虚拟文档内容，其中所有非 CSS 的代码都已经被替换为空白符")]),t._v(" "),a("li",[t._v("语言客户端接收到 VS Code 的响应，然后返回该响应")])])])]),t._v(" "),a("p",[t._v("这样一来，即使我们的代码不包含 CSS 处理库，也能够完成 CSS 的自动补全。而且 VS Code 更新 CSS 语言服务器的时候，我们的插件不用改动一行代码也获得了最新的 CSS 支持。")]),t._v(" "),a("p",[t._v("现在，我们来看看示例代码：")]),t._v(" "),a("h3",{attrs:{id:"请求转发示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#请求转发示例"}},[t._v("#")]),t._v(" 请求转发示例")]),t._v(" "),a("p",[t._v("!> 注意: 本示例假设你已经掌握了 "),a("a",{attrs:{href:"https://code.visualstudio.com/api/language-extensions/programmatic-language-features",target:"_blank",rel:"noopener noreferrer"}},[t._v("程序性语言特性"),a("OutboundLink")],1),t._v(" 和 "),a("a",{attrs:{href:"/language-extensions/language-server-extension-guide"}},[t._v("语言服务器")]),t._v(" 这2章内容。本示例构建于 "),a("a",{attrs:{href:"https://github.com/microsoft/vscode-extension-samples/tree/master/lsp-sample",target:"_blank",rel:"noopener noreferrer"}},[t._v("lsp-sample"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("建立文档 URI 和它们对应虚拟文档的映射，根据这个映射提供对应的请求：")]),t._v(" "),a("div",{staticClass:"language-typescript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-typescript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" virtualDocumentContents "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Map"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nworkspace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("registerTextDocumentContentProvider")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'embedded-content'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("provideTextDocumentContent")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" uri "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 移除前置 `/` 和结尾的 `.css`，获取原始 URI")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" originalUri "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" uri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" decodedUri "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("decodeURIComponent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("originalUri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" virtualDocumentContents"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("decodedUri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])]),a("p",[t._v("通过使用语言客户端的"),a("code",[t._v("middleware")]),t._v("，我们劫持了自动补全请求：")]),t._v(" "),a("div",{staticClass:"language-typescript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-typescript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" clientOptions"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" LanguageClientOptions "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  documentSelector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" scheme"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'file'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" language"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'html'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  middleware"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("provideCompletionItem")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" position"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果不在 `<style>`中, 不使用请求转发")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isInsideStyleRegion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n          htmlLanguageService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getText")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("offsetAt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("position"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" position"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" originalUri "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("uri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      virtualDocumentContents"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        originalUri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCSSVirtualContent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("htmlLanguageService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getText")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" vdocUriString "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("embedded-content://css/")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("encodeURIComponent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("originalUri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(".css")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" vdocUri "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Uri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vdocUriString"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" commands"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token generic-function"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("executeCommand")]),a("span",{pre:!0,attrs:{class:"token generic class-name"}},[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("CompletionList"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'vscode.executeCompletionItemProvider'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        vdocUri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        position"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("triggerCharacter\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br")])]),a("h2",{attrs:{id:"潜在问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#潜在问题"}},[t._v("#")]),t._v(" 潜在问题")]),t._v(" "),a("hr"),t._v(" "),a("p",[t._v("当实现嵌入语言服务器的时候，我们会遇到很多问题，到目前为止，我们也没有找到完美的方案，所以当你遇到下面的问题，可别说我们没有事先说过。")]),t._v(" "),a("h3",{attrs:{id:"很难实现语言特性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#很难实现语言特性"}},[t._v("#")]),t._v(" 很难实现语言特性")]),t._v(" "),a("p",[t._v("通常来说，围绕"),a("strong",[t._v("语言域")]),t._v("的语言特性都是很难实现的。自动补全或者悬停信息比较容易实现，是因为你可以检测嵌入内容的语言，并计算出一个结果。但是像代码格式化、全局重命名等功能就需要特殊处理了。在格式化功能中，你需要处理缩进和多个"),a("strong",[t._v("域")]),t._v("各自的的格式化配置问题。在重命名功能中，你也很在众多"),a("strong",[t._v("域")]),t._v("中找到正确的替换目标。")]),t._v(" "),a("h3",{attrs:{id:"语言服务器的状态太多而无法嵌入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#语言服务器的状态太多而无法嵌入"}},[t._v("#")]),t._v(" 语言服务器的状态太多而无法嵌入")]),t._v(" "),a("p",[t._v("VS Code 的 HTML 支持提供了 HTML、CSS 和 JavaScript特性。虽然 HTML 和 CSS 的语言服务是无状态的，但是受 TypeScript 服务器加强过的 JavaScript 语言特性就不一样了。我们只在 HTML 文档中的 JavaScript 提供了基本的支持，因为在这个里面，我们很难告诉 TypeScript 这个项目状态到底是什么。比如说，如果出用 "),a("code",[t._v("<script>")]),t._v(" 引入了一个CDN 上的 "),a("code",[t._v("lodash")]),t._v(" 库，那么其他每个 "),a("code",[t._v("<script>")]),t._v(" 脚本中都应该能够使用 "),a("code",[t._v("_.")]),t._v("自动补全。")]),t._v(" "),a("h3",{attrs:{id:"编码和解码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编码和解码"}},[t._v("#")]),t._v(" 编码和解码")]),t._v(" "),a("p",[t._v("文件的首要语言和嵌入的语言，他们的编解码和转义规则可能完全不同。比如，根据 "),a("a",{attrs:{href:"https://www.w3.org/TR/html401/appendix/notes.html#h-B.3.2",target:"_blank",rel:"noopener noreferrer"}},[t._v("HTML 规范"),a("OutboundLink")],1),t._v("，下面的 HTML 文档是无效的：")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("SCRIPT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("text/javascript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token script"}},[a("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n  document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<EM>This won\'t work</EM>"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("SCRIPT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("在这个例子里，语言服务器在处理"),a("code",[t._v("</")]),t._v("时应该转义为"),a("code",[t._v("<\\/")]),t._v("才行。")]),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("hr"),t._v(" "),a("p",[t._v("我们的这两种方法各有千秋。")]),t._v(" "),a("p",[t._v("语言服务：")]),t._v(" "),a("ul",[a("li",[a("ul",[a("li",[t._v("可获完全掌控语言服务器和用户体验")])])]),t._v(" "),a("li",[a("ul",[a("li",[t._v("无需依赖其他语言服务器。所有代码都在一个仓库内完成")])])]),t._v(" "),a("li",[a("ul",[a("li",[t._v("语言服务器可被所有 "),a("a",{attrs:{href:"https://microsoft.github.io/language-server-protocol/implementors/tools/",target:"_blank",rel:"noopener noreferrer"}},[t._v("LSP-兼容的代码编辑器"),a("OutboundLink")],1),t._v(" 重用")])])]),t._v(" "),a("li",[a("ul",[a("li",[t._v("可能很难嵌入用其他语言实现的语言服务")])])]),t._v(" "),a("li",[a("ul",[a("li",[t._v("需要持续维护语言服务依赖来获得新的特性")])])])]),t._v(" "),a("p",[t._v("请求转发：")]),t._v(" "),a("ul",[a("li",[a("ul",[a("li",[t._v("避免"),a("strong",[t._v("嵌入语言服务")]),t._v("与"),a("strong",[t._v("语言服务器")]),t._v("的非同构的问题（比如，在 Razor 语言服务器嵌入的 C# 编译器去支持 C#）")])])]),t._v(" "),a("li",[a("ul",[a("li",[t._v("无需维护上游的语言服务器来获取新功能")])])]),t._v(" "),a("li",[a("ul",[a("li",[t._v("无需诊断上游语言服务器的错误")])])]),t._v(" "),a("li",[a("ul",[a("li",[t._v("由于缺乏控制，很难和其他语言服务器分享状态信息")])])]),t._v(" "),a("li",[a("ul",[a("li",[t._v("多语言特性可能很难实现（比如，当书写 "),a("code",[t._v('<div class="foo">')]),t._v(" 中的 "),a("code",[t._v(".foo")]),t._v("时提供 CSS 补全）")])])])]),t._v(" "),a("p",[t._v("总体来说，我们还是更推荐用嵌入"),a("strong",[t._v("语言服务")]),t._v("构建嵌入语言服务器，因为这个方法更能掌控用户体验，而且这个服务器还可被任何 LSP 兼容的编辑器复用。但是如果你的场景比较简单，无需上下文、依赖语言服务器的状态或者没有能力打包一个 Node.js 库，那么你也可以考虑使用请求转发的方式。")])])}),[],!1,null,null,null);s.default=e.exports}}]);